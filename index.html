<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<style type="text/css">
	body {
		overflow:hidden;
	}
	#bg { position: absolute; z-index: 0; }
	#fg { position: absolute; z-index: 1; }
	canvas {
		position: absolute;
		padding-left: 0;
		padding-right: 0;
		margin-left: auto;
		margin-right: auto;
		display: block;
		height: 100%;
	}
	</style>
</head>
<body>
	<div id="container">
		<canvas id='bg'></canvas>
		<canvas id='fg'></canvas>
	</div>
	
<script>

var game_started = false;
var width = 100;
var height = 150;
var cellSize = 3;
var interCell = 0;
var color_transparent_opt = ' ';
var color_opt = "#000000:0,#00660f:1,#fcfc00:2,#0ffcf0:4,#00fc00:5,#00cc00:3,#6666ff:7,#009900:9,#ff0000:r,#00ff00:g,#0000ff:b,#ffffff:w";
var color_dict = {};

var opts = color_opt.split(',');
for(var i = 0; i < opts.length; i++){
	var pair = opts[i].split(':');
	color_dict[pair[1]] = pair[0];
}

var undef_char_img = '\n'+
'wwwwwwwwww\n'+
'w        w\n'+
'w        w\n'+
'w        w\n'+
'w        w\n'+
'w        w\n'+
'w        w\n'+
'w        w\n'+
'w        w\n'+
'wwwwwwwwww\n';

var ball_img = 
"     0000000     \n"+
"   00wwwwwww00   \n"+
"  0wwwwwwwwwww0  \n"+
" 0wwwww07www07w0 \n"+
"07777ww00www00ww0\n"+
"0ww777wwww0wwwww0\n"+
"0wwwwwwwwwwwwwww0\n"+
" 0ww0wwwwwwwwww0 \n"+
"  00 0000000000  ";
var pipe_img = "03gwggggg33g3339390";
var pipe2_img = 	"03gwgggggg33g33339390";
var pipe_edge_img = "000000000000000000000";

function readImg(str){
	var arr = [[]];
	for(var i = 0; i < str.length; i++){		
		var ch = str[i];
		if(ch == '\n'){ 
			if(arr[arr.length - 1].length > 0)
				arr.push([]);
		}
		else if(ch == '\r'){
			continue;
		}
		else {
			var line = arr[arr.length - 1];
			line.push(ch);
		}
	}
	if(arr[arr.length - 1].length == 0)
		arr.pop(arr[arr.length - 1]);
	return arr;
}

function createCanvas(str){
	var data = readImg(str);
	var canvas = document.createElement('canvas');
	canvas.width = data[0].length * (cellSize + interCell);
	canvas.height = data.length * (cellSize + interCell);
	drawOn(canvas.getContext('2d'), data, 0, 0);
	return canvas;
}

var char_images = [];

function setFontChar(ch, repr){
	var code = ch.charCodeAt(0);
	char_images[code] = createCanvas(repr);
}
setFontChar('0',
' wwwwwww \n'+
'www   www\n'+
'www   www\n'+
'wwwwwwwww\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
' wwwwwww ');
setFontChar('1',
'www \n'+
' www\n'+
' www\n'+
' www\n'+
' www\n'+
' www\n'+
' www\n'+
' www');
setFontChar('2',
'wwwwwww \n'+
'     www\n'+
'     www\n'+
' wwwwwww\n'+
'www     \n'+
'www     \n'+
'www     \n'+
'wwwwwwww');
setFontChar('3',
'wwwwwww \n'+
'     www\n'+
'     www\n'+
'  wwwww \n'+
'     ww \n'+
'     www\n'+
'     www\n'+
'wwwwwww ');
setFontChar('4',
'www  www\n'+
'www  www\n'+
'www  www\n'+
'wwwwwwww\n'+
'     www\n'+
'     www\n'+
'     www\n'+
'     www');
setFontChar('5',
'wwwwwwww\n'+
'www     \n'+
'www     \n'+
' wwwwww \n'+
'     www\n'+
'     www\n'+
'     www\n'+
'wwwwwww ');
setFontChar('6',
'wwwwwwww\n'+
'www     \n'+
'www     \n'+
'wwwwwww \n'+
'www  www\n'+
'www  www\n'+
'www  www\n'+
' wwwwww ');
setFontChar('7',
'wwwwwww \n'+
'     www\n'+
'     www\n'+
'     www\n'+
'     www\n'+
'     www\n'+
'     www\n'+
'     www');
setFontChar('8',
' wwwwww \n'+
'www  www\n'+
'www  www\n'+
' wwwwww \n'+
' ww  ww \n'+
'www  www\n'+
'www  www\n'+
' wwwwww ');
setFontChar('9',
' wwwwww \n'+
'www  www\n'+
'www  www\n'+
'wwwwwwww\n'+
'     www\n'+
'     www\n'+
'     www\n'+
'wwwwwww ');
setFontChar(' ', 
'     ');
setFontChar('a', 
' wwwwww \n'+
'www  www\n'+
'www  www\n'+
'www  www\n'+
'wwwwwwww\n'+
'www  www\n'+
'www  www\n'+
'www  www\n'+
'www  www\n'
);
setFontChar('e', 
'wwwwwwww\n'+
'www     \n'+
'www     \n'+
'www     \n'+
'wwwwww  \n'+
'www     \n'+
'www     \n'+
'www     \n'+
'wwwwwwww\n'
);
setFontChar('m', 
'wwwwwwwwwwwww \n'+
'www   www  www\n'+
'www   www  www\n'+
'www   www  www\n'+
'www   www  www\n'+
'www   www  www\n'+
'www   www  www\n'+
'www   www  www\n'+
'www   www  www\n'
);
setFontChar('o', 
' wwwwwww \n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
' wwwwwww \n'
);
setFontChar('r', 
'wwwwwwww \n'+
'www   www\n'+
'www   www\n'+
'www   ww \n'+
'wwwwwwww \n'+
'www   ww \n'+
'www   www\n'+
'www   www\n'+
'www   www\n'
);
setFontChar('v', 
'www   www\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
'www   www\n'+
'wwwwwwww \n'
);
setFontChar('g', 
' wwwwwww\n'+
'www     \n'+
'www     \n'+
'www     \n'+
'www wwww\n'+
'www  www\n'+
'www  www\n'+
'www  www\n'+
' wwwwwww\n'
);
var undef_char = createCanvas(undef_char_img);

function drawCellOn(ctx, i, j, colChar){
	if(i<0 || i>=height) return;
	if(j<0 || j>=width-1) return;
	if(colChar == color_transparent_opt) return;		
	ctx.fillStyle = color_dict[colChar];
	ctx.fillRect(0+j*(cellSize+interCell),0+i*(cellSize+interCell),cellSize,cellSize);
}
function drawOn(ctx, obj, x, y){
	for(var i = 0; i < obj.length; i++){
		for(var j = 0; j < obj[0].length; j++){
			var col = obj[i][j];
			drawCellOn(ctx, y + i, x + j, col);
		}
	}
}

var canvas_bg = document.getElementById("bg");
var ctx_bg = canvas_bg.getContext('2d');
ctx_bg.canvas.width  = width*(cellSize+interCell);
ctx_bg.canvas.height = height*(cellSize+interCell);
ctx_bg.fillStyle = "#335cff";
ctx_bg.fillRect(0, 0, width*(cellSize+interCell), height*(cellSize+interCell));

function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
}
function rgb(r,g,b){
	return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}
//=====================================================
var Renderer = function(){

	var viewportWidth = width * (cellSize + interCell);
	var viewportHeight = height * (cellSize + interCell);

	this.canvas = document.getElementById("fg");
	this.ctx = this.canvas.getContext("2d");
	this.canvas.width  = viewportWidth;
	this.canvas.height = viewportHeight;
	
	this.hidden_canvas = document.createElement("canvas");
	this.hidden_ctx = this.hidden_canvas.getContext("2d");
	this.hidden_canvas.width  = viewportWidth;
	this.hidden_canvas.height = viewportHeight;
	
	this.render = function(canvas, px, py) {
		this.hidden_ctx.drawImage(canvas, 
			Math.round(px * (cellSize + interCell)), 
			Math.round(py * (cellSize + interCell)), 
			canvas.width, 
			canvas.height);
	};
	
	this.renderString = function(string, cx, cy){
		var chars = string.toLowerCase().split("");
		var list = [];
		var interCharSpace = 1;
		var strWidth = (chars.length-1)*interCharSpace;		
		for(var i = 0; i < chars.length; i++){
			var index = chars[i].charCodeAt(0);
			var achar;
			if(char_images[index])
				achar = char_images[index];
			else
				achar = undef_char;
			list.push(achar);
			strWidth += achar.width;
		}
		var strHeight = list[0].height;
		var x = cx - strWidth / (cellSize + interCell) / 2;
		var y = cy - strHeight / 2;
		for(var i = 0; i < list.length; i++){
			var achar = list[i];
			this.render(achar, x, y);		
			x += achar.width / (cellSize + interCell) + interCharSpace;
		}
	}
	
	this.pre_render = function(){
		this.hidden_ctx.canvas.width = this.hidden_ctx.canvas.width;
	};
	
	this.post_render = function(){
		this.ctx.canvas.width = this.ctx.canvas.width;
		this.ctx.drawImage(this.hidden_canvas, 0, 0, viewportWidth, viewportHeight);
	};
}

var renderer = new Renderer();
//-----------------------------------------------------
var ContentManager = function(){
	this.canvases = {};
	
	var imgData = readImg(ball_img);
	var hero_canvas = document.createElement("canvas");
	var hero_ctx = hero_canvas.getContext("2d");
	hero_canvas.width  = imgData[0].length * (cellSize + interCell);
	hero_canvas.height = imgData.length * (cellSize + interCell);
	drawOn(hero_ctx, imgData, 0, 0);
	
	this.canvases['hero'] = hero_canvas;
	
	this.getCanvas = function(name){
		return this.canvases[name];
	}
};

var resoures = new ContentManager();
//=====================================================
// MODELS
//=====================================================
var Ball = function(){

	this.canvas = resoures.getCanvas('hero');
	this.ctx = this.canvas.getContext("2d");	
	
	this.width = this.canvas.width / (cellSize + interCell);
	this.height = this.canvas.height / (cellSize + interCell);
	this.X = 0;
	this.Y = 0;
	this.velocityX = 0;
	this.velocityY = 0;
	this.acc = 1.00;
	
	
	
	this.place = function(x, y){
		this.X = x;
		this.Y = y;
	};
	this.update = function(dt){
		if(game_started){
			this.velocityX += 0;
			this.velocityY += 9.8 * 20 * dt;
		}
		this.X += this.velocityX * dt;
		this.Y += this.velocityY * dt;
	};	
	this.draw = function(){
		renderer.render(this.canvas, this.X, this.Y);
	};
	this.pushUp = function(){
		this.velocityY = - 9.8 * 8;
	};
};
//----------------------
var Pipe = function(){

	this.image = readImg(pipe_img);
	this.image2 = readImg(pipe2_img);
	this.image3 = readImg(pipe_edge_img);
	this.width = this.image3[0].length;
	this.hole = 30;
	this.pre_hole = 10;
	this.posY = Math.floor((Math.random() * (height - this.hole - 5)) + 5);
	this.X = width;
	this.velocityX = -30;
	this.destroy = false;
	this.pass = false;
	
	this.canvas = document.createElement("canvas");
	this.ctx = this.canvas.getContext("2d");
	this.ctx.canvas.width  = this.width * (cellSize + interCell);
	this.ctx.canvas.height = height * (cellSize+interCell);
	
	this.preDraw = function(){
		var x = 0;
		var preY = this.posY - this.pre_hole;
		if (preY < 0) 
			preY = 0;
		else 
			drawOn(this.ctx, this.image3, x, preY);
		for(var i = 0; i < preY; i++){
			drawOn(this.ctx, this.image, x + 1, i);
		}
		for(var i = preY + 1; i < this.posY; i++){
			drawOn(this.ctx, this.image2, x, i);
		}
		drawOn(this.ctx, this.image3, x, this.posY);
		var preY2 = this.posY + this.hole;
		var preY3 = preY2 + this.pre_hole;
		drawOn(this.ctx, this.image3, x, preY2);
		for(var i = preY2 + 1; i < preY3 && i < height; i++){
			drawOn(this.ctx, this.image2, x, i);
		}
		if(preY3 < height)
			drawOn(this.ctx, this.image3, x, preY3);
		for(var i = preY3 + 1; i < height; i++){
			drawOn(this.ctx, this.image, x + 1, i);
		}
	};
	
	this.preDraw();
	
	this.draw = function(){		
		renderer.render(this.canvas, this.X, 0);		
	};
	
	this.update = function(dt){
		this.X += this.velocityX * dt;
		if(this.X + this.width < 0){
			this.destroy = true;
			delete this.canvas;
		}
	};
	
	this.collidesWith = function(b){
		var thisRight = this.X + this.width;
		var bRight = b.X + b.width;
		var bBottom = b.Y + b.height;
		var thisY2 = this.posY + this.hole;
		if(bRight >= this.X &&  b.X <= thisRight){
			if(b.Y <= this.posY || bBottom >= thisY2)
				return true;
		}
		return false;
	};
	
	this.passed = function(b){
		var thisRight = this.X + this.width;
		if(!this.pass && (b.X > thisRight)){
			this.pass = true;
			return true;
		}
		return false;
	}
};
//=====================================================
function onSpacebarPush(){
	if(!game_started){
		game_started = true;
	} else {
		if(game_over){
			game_over = false;
			Game.init();
		}
	}	
	Game.ball.pushUp();
}

$(document).on("tap",function(){
   onSpacebarPush();
});
$(document).keyup(function(e){

	var checkWebkitandIE = (e.keyCode==32 ? 1 : 0);
    var checkMoz = (e.keyCode==32 ? 1 : 0);
	
    if (checkWebkitandIE || checkMoz) {	
		onSpacebarPush();
	}
});
//=====================================================
var game_over = false;
var Game = {};
Game.init = function() {
	Game.fps = 30;
	Game.score = 0;
	Game.ball = new Ball();
	Game.ball.place(30, height / 2);
	Game.pipes = [];
	// @todo grass
	Game.counter = 0;
};
Game.update = function() {
	if(game_over) return;
	var dt = Game.fps/1000;
	Game.ball.update(dt);
	if(Game.ball.Y + Game.ball.height >= height){
		Game.ball.Y = height - Game.ball.height;
		game_over = true;
	}
	for(var i =0; i < Game.pipes.length; i++){
		var pipe = Game.pipes[i];
		if(!pipe.destroy)
			pipe.update(dt);
		if(pipe.collidesWith(Game.ball)){
			game_over = true;
		}
		if(pipe.passed(Game.ball)){
			Game.score++;
		}
	}
	if(game_started){
		Game.counter += dt;
		if(Game.counter > 2.5){
			Game.counter = 0;
			Game.pipes.push(new Pipe());
		}
	}
};
Game.draw = function() {
	var t_start = Date.now();
	
	renderer.pre_render();
	
	for(var i =0; i < Game.pipes.length; i++){
		var pipe = Game.pipes[i];
		if(!pipe.destroy)
			pipe.draw();
	}
	
	Game.ball.draw();
	renderer.renderString("" + Game.score, width/2, height/4);
	if(game_over)
		renderer.renderString("game over", width/2, height/2);
	
	renderer.post_render();
	
	var t_end = Date.now();
	console.log((t_end-t_start)+"ms");
};
Game.init();
Game.run = (function() {
	var loops = 0, 
		skipTicks = 1000 / Game.fps,
		maxFrameSkip = 10,
		nextGameTick = (new Date).getTime();
	return function() {
		loops = 0;
		while ((new Date).getTime() > nextGameTick) {
			//updateStats.update();
			Game.update();
			nextGameTick += skipTicks;
			loops++;
		}
		//renderStats.update();
		Game.draw();
	};
})();
(function() {
  var onEachFrame;
  if (window.webkitRequestAnimationFrame) {
    onEachFrame = function(cb) {
      var _cb = function() { cb(); webkitRequestAnimationFrame(_cb); }
      _cb();
    };
  } else if (window.mozRequestAnimationFrame) {
    onEachFrame = function(cb) {
      var _cb = function() { cb(); mozRequestAnimationFrame(_cb); }
      _cb();
    };
  } else {
    onEachFrame = function(cb) {
      setInterval(cb, 1000 / 60);
    }
  }
  
  window.onEachFrame = onEachFrame;
})();
window.onEachFrame(Game.run);
</script>
</body>
</html>
